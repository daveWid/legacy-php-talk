<!doctype html>
<html lang="en">
<head>
	<title>Updating Legacy PHP</title>

	<meta charset="utf-8" />

	<link type="text/css" rel="stylesheet" href="assets/style.css" />

	<script src="assets/jquery-1.7.min.js"></script>
	<script src="assets/modernizr.custom.js"></script>
	<script src="assets/highlight.pack.js"></script>
	<script src="assets/deck.js"></script>
	<script src="assets/script.js"></script>
</head>
<body>
	<article>
		<section class="slide full">
			<h1 class="vcenter">Updating Legacy Code</h1>

			<div class="call-out">
				Dave Widmer<br />
				Web Applications Developer: <span class="bgsu"><strong>BG</strong>SU</span><br />
				@davewidmer
			</div>
		</section>

		<section class="slide full">
			<h2>Functional: upload.php</h2>

			<pre><code class="php">// file to ftp
$file = $_FILES['userfile']['name'];
$filetype=$_FILES["userfile"]["type"];  

if($filetype != "application/msword" and $filetype != "application/pdf") {
	die('Invalid file, click &lt;a href="./index.php?error=INV_FILE_EXT">here&lt;/a> to retry!');
}
$ftp_path = '/data/' . $file;

// FTP credentials
$host = 'HOST';
$user = 'USERNAME';
$pswd = 'PASSWORD';

// connect to FTP server (port 21)
$c_id = ftp_connect($host, 21) or die("Cannot connect to host");

// send access parameters
ftp_login($c_id, $user, $pswd) or die("Cannot login");

// do the file upload
$upload = ftp_put($c_id, $ftp_path, $file, FTP_ASCII);
// if your server requires passive mode transfers, use this instead
// $upload = ftp_pasv ($c_id, true);

// check to see if upload was successful
print (!$upload) ? 'Cannot upload' : 'Upload complete';
print "\n";

// close the FTP session
ftp_close($c_id);</code></pre>	
		</section>

		<section class="slide full alternate">
			<h1 class="vcenter">What Are We Doing?</h1>
		</section>

		<section class="slide full">
			<h2>File</h2>

			<div class="slide">
				<h3>Prepare</h3>

				<pre><code class="php">$file = $_FILES['userfile']['name'];
$filetype=$_FILES["userfile"]["type"];</code></pre>
			</div>

			<div class="slide">
				<h3>Validate</h3>

				<pre><code class="php">if($filetype != "application/msword" and $filetype != "application/pdf") {
	die('Invalid file, click &lt;a href="./index.php?error=INV_FILE_EXT">here&lt;/a> to retry!');
}</code></pre>
			</div>
		</section>

		<section class="slide full">
			<h2>FTP Server</h2>

			<div class="slide">
				<h3>Configuration</h3>
				
				<pre><code class="php">$host = 'HOST';
$user = 'USERNAME';
$pswd = 'PASSWORD';</code></pre>
			</div>

			<div class="slide">
				<h3>Connect</h3>

				<pre><code class="php">$c_id = ftp_connect($host, 21) or die("Cannot connect to host");
ftp_login($c_id, $user, $pswd) or die("Cannot login");</code></pre>
			</div>

			<div class="slide">
				<h3>Upload</h3>

				<pre><code class="php">$upload = ftp_put($c_id, $ftp_path, $file, FTP_ASCII);
// $upload = ftp_pasv ($c_id, true); // if your server requires passive mode transfers, use this instead</code></pre>
			</div>

			<div class="slide">
				<h3>Disconnect</h3>

				<pre><code class="php">ftp_close($c_id);</code></pre>
			</div>
		</section>

		<section class="slide full alternate">
			<h1 class="vcenter">So Now What?!?</h1>
		</section>

		<section class="slide full">
			<h1 class="vcenter">Classes!</h1>
		</section>

		<section class="slide full">
			<h2>NWOPUG\FTP\File</h2>

			<pre><code class="php">&lt;?php

namespace NWOPUG\FTP;

class File
{
  private $file;

  public function __construct($file)
  {
    $this->file = $file;
  }

  public function getName()
  {
    return $this->file['name'];
  }

  public function getType()
  {
    return $this->file['type'];
  }

  public function isValid()
  {
    $validTypes = array('application/msword', 'application/pdf');
    return in_array($this->getType(), $validTypes);
  }
}</code></pre>
		</section>

		<section class="slide full">
			<h2>Start Fresh: upload.php</h2>

			<pre><code class="php">include "NWOPUG/FTP/File.php";

$file = new \NWOPUG\FTP\File($_FILES['userfile']);</code></pre>

			<div class="slide">
				<h3>var_dump($file)</h3>

				<pre><code class="php">object(NWOPUG\FTP\File)#12 (1) {
  ["file":"NWOPUG\FTP\File":private]=>
  array(5) {
    ["name"]=> string(13) "test_file.doc"
    ["type"]=> string(18) "application/msword"
    ["size"]=> string(7) "1000000"
    ["tmp_name"]=> string(12) "Lhdf8yajskdl"
    ["error"]=> int(0)
  }
}</code></pre>
			</div>

			<div class="slide">
				<h3>$file->file;</h3>

				<pre><code class="php">PHP Fatal error:  Cannot access private property NWOPUG\FTP\File::$file</code></pre>
			</div>
		</section>

		<section class="slide full">
			<h2>Validation: upload.php</h2>

			<pre><code class="php">include "NWOPUG/FTP/File.php";

$file = new \NWOPUG\FTP\File($_FILES['userfile']);

if ( ! $file->isValid()) {
 // Send user error message
}

// If we make it here we are good!</code></pre>
		</section>

		<section class="slide full alternate">
			<h1 class="vcenter">Easier to Read?</h1>
		</section>

		<section class="slide full">
			<h2>NWOPUG\FTP</h2>

			<pre><code class="php">namespace NWOPUG;

class FTP
{
  private $config;
  private $connection = null;

  public function __construct(array $config)
  {
    $this->config = $config;

    $this->connection = ftp_connect($this->config['host'], $this->config['port']);
    if ($this->connection === false)
    {
      throw new \UnexpectedValueException('Can not connect to '.$this->config['host']);
    }

    $login = ftp_login($this->connection, $config['user'], $config['password']);
    if ($login === false)
    {
      throw new \UnexpectedValueException('Invalid login');
    }
  }

  public function upload($file, $path, $mode = \FTP_ASCII)
  {
    return ftp_put($this->connection, $path, $file, $mode);
  }

  public function __destruct()
  { 
    ftp_close($this->connection);
  }
}</code></pre>
		</section>

		<section class="slide full">
			<h2>FTP: upload.php</h2>

			<pre><code class="php">include "NWOPUG/FTP/File.php";
include "NWOPUG/FTP.php";

$file = new \NWOPUG\FTP\File($_FILES['userfile']);

if ( ! $file->isValid()) {
 // Send user error message
}

$config = array(
  'host' => 'ftp.testing.com',
  'port' => 21,
  'user' => 'test',
  'password' => 'youllneverguess'
);

$ftp = new \NWOPUG\FTP($config);
$success = $ftp->upload($file->getTmpName(), "/data/".$file->getName());

if ( ! $success) {
  // Send user error message
}

// Success!</code></pre>
		</section>

		<section class="slide full">
			<h2>Optimize: upload.php</h2>

			<pre><code class="php">// Autoload
<del>include "NWOPUG/FTP/File.php";
include "NWOPUG/FTP.php";</del>

$file = new \NWOPUG\FTP\File($_FILES['userfile']);

if ( ! $file->isValid()) {
 // Send user error message
}

// Keep in configuration file outside of webroot
<del>$config = array(
  'host' => 'ftp.testing.com',
  'port' => 21,
  'user' => 'test',
  'password' => 'youllneverguess'
);</del>

$ftp = new \NWOPUG\FTP($config);
$success = $ftp->upload($file->getTmpName(), "/data/".$file->getName());

if ( ! $success) {
  // Send user error message
}

// Success!</code></pre>
		</section>

		<section class="slide full">
			<h2>Updated: upload.php</h2>

			<pre><code class="php">$file = new \NWOPUG\FTP\File($_FILES['userfile']);

if ( ! $file->isValid()) {
 // Send user error message
}

$ftp = new \NWOPUG\FTP($config);
$success = $ftp->upload($file->getTmpName(), "/data/".$file->getName());

if ( ! $success) {
  // Send user error message
}

// Success!</code></pre>
		</section>
	</article>

	<script src="assets/presentation.js"></script>
</body>
</html>
